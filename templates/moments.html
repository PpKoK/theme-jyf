<!DOCTYPE html>
<html 
  xmlns:th="https://www.thymeleaf.org"
  th:replace="~{modules/layout :: html(title = '瞬间 - ' + ${site.title}, content = ~{::content})}"
>
  <th:block th:fragment="content">
    <div class="moments-page">
      <!-- 页面标题 -->
      <div class="page-header">
        <h1 class="page-title">瞬间</h1>
        <p class="page-description">记录生活中的点点滴滴</p>
      </div>
      
      <!-- 标签筛选 -->
      <div class="moment-tags-filter" th:if="${not #lists.isEmpty(tags)}">
        <a 
          href="/moments" 
          class="tag-filter-btn"
          th:classappend="${#lists.isEmpty(param.tag) ? 'active' : ''}"
        >
          全部
        </a>
        <th:block th:each="tag : ${tags}">
          <a 
            th:href="|/moments?tag=${tag.name}|"
            class="tag-filter-btn"
            th:classappend="${#lists.contains(param.tag, tag.name) ? 'active' : ''}"
          >
            <span th:text="${tag.name}"></span>
          </a>
        </th:block>
      </div>
      
      <!-- 瞬间列表 -->
      <div class="moments-list">
        <th:block th:each="moment : ${moments.items}" th:with="content=${moment.spec.content}">
          <div class="moment-item">
            <!-- 头像 -->
            <div class="moment-avatar">
              <img 
                th:src="${moment.owner.avatar ?: '/assets/default-avatar.png'}" 
                th:alt="${moment.owner.displayName}"
              >
            </div>
            
            <!-- 瞬间内容 -->
            <div class="moment-content-wrapper">
              <!-- 用户名和时间 -->
              <div class="moment-header">
                <span class="moment-author" th:text="${moment.owner.displayName}"></span>
                <span class="moment-time" th:text="${#dates.format(moment.spec.releaseTime, 'yyyy-MM-dd HH:mm')}"></span>
              </div>
              
              <!-- 瞬间正文（移除标签） -->
              <div
                class="moment-text"
                th:if="${not #strings.isEmpty(content.html)}"
                th:utext="${#strings.replace(#strings.replace(content.html, '<a', '<span'), '</a>', '</span>')}"
              ></div>
              
              <!-- 瞬间媒体（图片/视频/音频） -->
              <div class="moment-media" th:if="${not #lists.isEmpty(content.medium)}">
                <th:block th:each="mediaItem : ${content.medium}">
                  <!-- 图片 -->
                  <div class="moment-media-item moment-photo" th:if="${mediaItem.type.name() == 'PHOTO'}">
                    <img 
                      th:src="${mediaItem.url}" 
                      th:alt="'瞬间图片'"
                      loading="lazy"
                    >
                  </div>
                  <!-- 视频 -->
                  <div class="moment-media-item moment-video" th:if="${mediaItem.type.name() == 'VIDEO'}">
                    <video 
                      th:src="${mediaItem.url}" 
                      controls
                      preload="metadata"
                    ></video>
                  </div>
                  <!-- 音频 -->
                  <div class="moment-media-item moment-audio" th:if="${mediaItem.type.name() == 'AUDIO'}">
                    <audio 
                      th:src="${mediaItem.url}" 
                      controls
                    ></audio>
                  </div>
                </th:block>
              </div>
              
              <!-- 瞬间标签 -->
              <div class="moment-tags" th:if="${not #lists.isEmpty(moment.spec.tags)}">
                <th:block th:each="tag : ${moment.spec.tags}">
                  <a 
                    th:href="|/moments?tag=${tag}|" 
                    class="moment-tag"
                    th:text="'#' + ${tag}"
                  ></a>
                </th:block>
              </div>
              
              <!-- 瞬间互动 - 点赞 -->
              <div class="moment-actions">
                <button
                  class="moment-upvote-btn"
                  th:data-name="${moment.metadata.name}"
                  th:data-upvote="${moment.stats.upvote ?: 0}"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                  </svg>
                  <span class="upvote-count" th:text="${moment.stats.upvote ?: 0}"></span>
                </button>
              </div>
            </div>
          </div>
        </th:block>
      </div>
      
      <!-- 分页 -->
      <div 
        class="pagination" 
        th:if="${moments.hasPrevious()} or ${moments.hasNext()}"
      >
        <a 
          th:if="${moments.hasPrevious()}" 
          th:href="@{${moments.prevUrl}}" 
          class="pagination-btn"
        >
          ← 上一页
        </a>
        <span class="pagination-info">
          第 <span th:text="${moments.page}"></span> 页
        </span>
        <a 
          th:if="${moments.hasNext()}" 
          th:href="@{${moments.nextUrl}}" 
          class="pagination-btn"
        >
          下一页 →
        </a>
      </div>
      
      <!-- 空状态 -->
      <div class="no-moments" th:if="${#lists.isEmpty(moments.items)}">
        <p>还没有发布任何瞬间</p>
      </div>
    </div>
  </th:block>
</html>